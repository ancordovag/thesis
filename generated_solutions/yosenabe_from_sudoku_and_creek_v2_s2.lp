% Define all possible directions
dir(0,1). dir(0,-1). dir(1,0). dir(-1,0).

% Define a path between two cells when they are adjacent
path(X,Y,P,Q) :- cell(X,Y), cell(P,Q), |P-X| + |Q-Y| = 1.

% Define a move from one cell to another in a specific direction
move(X,Y,P,Q,DX,DY) :- path(X,Y,P,Q), dir(DX,DY).

% Define a target cell for a number in an area
target(X,Y,P,Q) :- number(X,Y,N), area(P,Q,A), goal(A,G), G = N, move(X,Y,P,Q,DX,DY), not move(X,Y,P+DX,Q+DY,DX,DY).

% Show output predicate target
#show target/4.
% For each number, it must be moved into one of the gray areas
:- number(X,Y,N), not target(X,Y,P,Q).

% For each gray area, at least one number must be moved into it
:- area(X,Y,A), not target(X,Y,P,Q).

% The sum of the numbers moved into an area must be equal to the goal of the area
:- area(X,Y,A), goal(A,G), not sum_numbers(X,Y,A,G).

% The ways of any two moved numbers must not cross or meet at any grid cell
:- target(X,Y,P,Q), target(X,Y,R,S), (X,Y) != (P,Q), (X,Y) != (R,S), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R,S), (X,Y) != (R,S), (X,Y) != (P,Q), (P,Q) != (R